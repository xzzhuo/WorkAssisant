<!DOCTYPE html>

<script type="text/javascript" src="js/jquery-1.10.2.js"></script>

<meta charset="utf-8" />
<title>WebSocket Test</title>
<script language="javascript"type="text/javascript">  
    var wsUri ="ws://localhost:8081/websocket"; 
    var output;
    var account = "${account}";

    function init() {
        output = document.getElementById("output");
        $('#input_url').val(wsUri)
        doOpen(wsUri);
    }

    function onConnect(evt) { 
    	$('#btn_connect').attr("disabled", true);
    	$('#btn_disconnect').attr("disabled", false);
    	$('#input_url').attr("disabled", true);
    	$('#btn_send').attr("disabled", false);
    	
        doSend('{"command":{"name":"GET_FRIND_LIST","account":"' + account + '"}}'); 
    }  
 
    function onClose(evt) { 
    	$('#btn_connect').attr("disabled", false);
    	$('#btn_disconnect').attr("disabled", true);
    	$('#input_url').attr("disabled", false);
    	$('#btn_send').attr("disabled", true);
    }  

    function onMessage(evt) { 
        writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data + '</span>');
        
        try
        {
        	var retval = JSON.parse(evt.data);
        	writeToScreen('<span style="color: green;">JSON: ' + retval.command.name + '</span>');
        	
        	if (retval.command.state == "success")
        	{
        		if (retval.command.name == "GET_FRIND_LIST")
            	{
            		showList(retval.data);
            	}
        		else if (retval.command.name == "CHAT_CONTENT")
        		{
        			showMessage(retval.data);
        		}
        	}
        }
        catch (e)
        {
        	writeToScreen('<span style="color: green;">JSON: ' + e + '</span>');
        }
    }
 
    function onError(evt) { 
        writeToScreen('<span style="color: red;">ERROR:</span> '+ evt.data); 
    }  
 
    function doSend(message) {
        writeToScreen("SENT: " + message);
        websocket.send(message); 
    }
    
    function doOpen(wsUri) {
    	websocket = new WebSocket(wsUri);
        websocket.onopen = function(evt) {
        	onConnect(evt)
        };
        websocket.onclose = function(evt) {
            onClose(evt)
        };
        websocket.onmessage = function(evt) {
            onMessage(evt)
        };
        websocket.onerror = function(evt) {
            onError(evt)
        };
    }
    
    function doChat(message, to) {
    	jsonValue = '{"command":{"name":"CHAT_CONTENT","account":"' + account + '","to":"' + to + '"},"data":"' + message + '"}';
    	doSend(jsonValue); 
    }

    function doClose() {
        websocket.close();
    }
 
    function writeToScreen(message) { 
        var pre = document.createElement("p");
        pre.style.wordWrap = "break-word"; 
        pre.innerHTML = message; 
        output.appendChild(pre); 
    }
    
    function showList(data) {
		var tbody=$("<tbody></tbody>");
		$("#frind_list").html(tbody);

		for(var i=0;i<data.length;i++)
		{
			var tr=$("<tr></tr>");
			tr.appendTo(tbody);
           
			var tdImg = $("<td></td>");
           
			if (data[i].photo.length > 0) {
				tdImg = $("<td><img width='32px' height='32px' src='upload/" + data[i].account + "/" + data[i].photo + "'/></td>");
			}
			tdImg.appendTo(tr)
           
			var tdAccount = $("<td onclick=\"selectAccount('" + data[i].account + "')\">"+ data[i].account +"</td>");
			// var tdAccount = $("<td id = 'account" + i + "' onclick=\"selectAccount('" + data[i].account + "')\">"+ data[i].account +"</td>");
			tdAccount.appendTo(tr);
			
			// alert(tr.html());
		}
	}

    function selectAccount(account)
    {
    	$("#input_account").val(account);
    }

    window.addEventListener("load", init, false);
    
    function showMessage(data)
    {
    	var output = document.getElementById("message");
    	var pre = document.createElement("p");
        pre.style.wordWrap = "break-word"; 
        pre.innerHTML = data.message; 
        output.appendChild(pre);
    }
</script>

<body>
<h2>WebSocket Test: ${account}</h2>  

<div>
	<div class="zone_connect" style="position:absolute;top:60px;left:10px;">
		<input type="text" id="input_url" style="width:366px;" placeholder="websocket address" />
		<button type="button" id="btn_connect" onclick="doOpen($('#input_url').val());">Connect</button>
		<button type="button" id="btn_disconnect" disabled="disabled" onclick="doClose();">Disconnect</button>
	</div>
	<div class="zone_list" style="position:absolute;top:90px;left:10px;">
		<table border="1" style="width:150px;height:375px;" id="frind_list"></table>
	</div>
	<div class="zone_message" style="position:absolute;top:90px;left:180px;">
		<textarea id="message" style="width:300px;height:300px;"></textarea>
	</div>
	<div class="zone_output" style="position:absolute;top:90px;left:500px;">
		<textarea id="output" style="width:300px;height:300px;"></textarea>
	</div>
	<div class="zone_send" style="position:absolute;top:400px;left:180px;">
		<textarea id="input_send" style="width:300px;height:60px;" placeholder="send data"></textarea>
		<br />
		<input id="input_account" disabled="disabled"></input>
		<button type="button" id="btn_send" class="btn btn-default" disabled="disabled" onclick="doChat($('#input_send').val(), $('#input_account').val());">Send(ctrl+Enter)</button>
	</div>
</div>


        
</body>
</html>
